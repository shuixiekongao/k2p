name: Build ImmortalWrt for K2P

on:
  workflow_dispatch: # 手动点击开始编译

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: Clone source code
        run: |
          git clone --depth 1 https://github.com/immortalwrt/immortalwrt -b master openwrt

      - name: Update & Install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load custom configuration
        run: |
          [ -e .config ] && mv .config openwrt/.config
          cat >> openwrt/.config <<EOF
          CONFIG_TARGET_ramips=y
          CONFIG_TARGET_ramips_mt7621=y
          CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y
          # 语言包
          CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
          # SmartDNS
          CONFIG_PACKAGE_luci-app-smartdns=y
          CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y
          # PassWall (包含常用协议)
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-i18n-passwall-zh-cn=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_V2ray=y
          EOF
          cd openwrt && make defconfig

      - name: Download package
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile the firmware
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt_K2P_Firmware
          path: openwrt/bin/targets/ramips/mt7621/*.bin
